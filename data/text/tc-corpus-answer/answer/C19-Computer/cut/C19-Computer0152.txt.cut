微型,型电脑,电脑,应用,
MICROCOMPUTER,APPLICATIONS
2000,Vol,16,No,P,51,53



Windows,9X,硬件,中断,设备,驱动,驱动程序,程序,开发,姜,山,程,君,实,摘,本文,介绍,PC,Windows,9X,平台,台下,实现,现实,实时,实时控制,控制,关键,关键技术,技术,一一,实时,时钟,中断,获取,方法,虚拟,拟设,设备,驱动,驱动程序,程序,VxD,VtoolsD,工具,工具箱,进行,简要,介绍,源代码,代码,分析,说明,实时,硬件,中断,VxD,实现,过程,关键,关键词,控制,控制系统,系统,实时,系统,虚拟,拟设,设备,驱动,驱动程序,程序,VtoolsD
Abstract,This,paper,describes,the,method,of,acquiring,rea,l,time,clock,interrupts,which,is,the,key,technology,of,real,time,system,design,based,on,PC,and,Windows,9x,The,VxD,Virtual,Device,Driver,and,VtoolsD,Toolbox,ar,e,also,introduced,briefly,Implementation,of,the,real,time,interrupt,VxD,is,illu,strated,by,the,source,code,analysis,
Keywords,control,system,real,time,system,virtual,device,driver,VtoolsD,绪言,计算,计算机,计算机控制,算机,控制,领域,硬件,发展,原本,十分,十分复杂,复杂,控制,控制算法,算法,设计,仿真,变得,越来,越来越,容易,实现,VME,MULTIBUS,STD,总线,平台,相比,ISA,总线,高性,高性能,性能,PC,工控,工控机,IPC,无疑,近来,应用,最为,广泛,主流,主流产品,流产,产品,主要,得益,得益于,益于,IPC,PC,软件,兼容,兼容性,容性,开放,开放性,结构,外围,高性,高性能,性能,I,O,模板,不断,不断涌现,涌现,实,工业,网络,迅速,发展,IPC,创造,有利,发展,环境,IPC,时代,已经,到来,当今,计算,计算机,计算机控制,算机,控制,领域,控制,控制软件,软件,是否,Windows,平台,已经,成为,产品,是否,竞争,竞争力,重要,标准,目前,Windows,平台,相关,产品,已经,占据,市场,市场份额,份额,90,Windows,9X,Windows,NT,出色,多任务,任务,图形,用户,接口,GUI,性能,性能优越,优越,硬件,兼容,兼容性,容性,卓越,32,软件,环境,性能,已经,越来,越来越,广泛,地被,应用,用于,工业,控制,成为,实现,现实,实时,实时控制,控制,优秀,平台,Windows,NT,其实,实时,扩展,PTX4,相比,Windows,9X,应用,更为,广泛,灵活,硬件,要求,苛刻,本文,讨论,Windows,9X,实现,现实,实时,实时控制,控制,关键,关键技术,技术,一一,实时,时时,时钟,中断,驱动,驱动程序,程序,设计,实现,Windows,9X,实时,钟,获得,实时,实时控制,控制,中断,技术,应用,用得,十分,广泛,中实,实时,时时,时钟,获得,基本,基本上,中断,实现,时钟,控制,实时,实时控制,控制,处于,十分,重要,地位,负责,推进,控制,过程,激活,控制,任务,发,控制,消息,起到,总控,控制,控制器,作用,Windows,9X,实时,时时,时钟,获得,不同,方法,设置,Win32,定时,定时器,响应,WM,TIMER,消息,进行,实时,实时处理,处理,简单,方法,WM,TIMER,消息,低优先级,优先,优先级,未处理,处理,消息,消息,队列,组合,造成,系统,实时,实时处理,处理,不稳,稳定,这种,方法,适合,实时,实时性,要求,高,应用,采用,Windows,多媒体,媒体,定时,定时器,设置,回调,函数,获得,最高,高精度,精度,Ims,定时,信号,占用,系统,宝贵,资源,定时,信号,用户,提供,需要,更,高,中断,频率,这种,方法,显得,无能,无能为力,类似,软件,中断,方法,法相,相比,硬件,中断,方法,占据,主导,主导地位,地位,绝大,绝大多数,大多,大多数,多数,实时,系统,得到,应用,保证,实时,实时控制,控制,控制系统,系统,至关,至关重要,重要,可靠,可靠性,本文,讨论,PC,Windows,9X,环境,实时,实时控制,控制,控制系统,系统,设计,实现,最为,关键,硬件,中断,VxD,实现,三,VxD,VtoolsD
,VxD,32,保护,保护模式,模式,执行,DLL,用于,管理,管理系,管理系统,系统,系统资源,资源,VxD,运行,Windows,VMM,监控,之下,VMM,VxDs,共同,同构,构成,Windows,Ring,层,系统,内核,开发,发虚,虚拟,拟设,设备,驱动,驱动程序,程序,VxD,常规,方法,使用,Microsoft,出品,设备,驱动,驱动程序,程序,程序开发,开发,开发工具,工具,工具包,DDK,Device,Developer,Kit,要求,设计,设计者,必须,Windows,95,体系,体系结构,结构,设备,驱动,驱动程序,程序,结构,VMM,Virtual,Machine,Manager,虚拟,虚拟机,管理,管理器,理器,Intel,CPU,体系,体系结构,结构,深入,了解,需要,保护,保护模式,模式,汇编,汇编语言,语言,编程,经验,现在,很少,少有,有人,使用,SDK,开发,Windows,应用,应用程序,程序,取而代之,代之以,MFC,OWL,C++,类库,编程,DDK,开发,开发人员,发人,人员,现在,以使,使用,类似,VtoolsD,WinDriver,第三,第三方,三方,软件,编制,驱动,驱动程序,程序,笔者,推荐,使用,VtoolsD,Vireo,公司,出色,VtoolsD,可视,VxD,代码,代码生成,生成,生成器,成器,QuickVxD,C,运行,运行库,行库,VMM,VxD,服务,库,C++,类库,VxD,装入,程序,组成,利用,QuickVxD,生成,框架,程序,充分,测试,试过,C,运行,运行库,行库,C++,类库,绕过,DDK,C,C++,编制,驱动,驱动程序,程序,大大,大地,简化,开发,难度,提高,可靠,可靠性,框架,程序,直接,接在,Visual,C++,集成,开发,环境,中用,NMAKE,编译,译为,VxD,四,硬件,中断,驱动,驱动程序,程序,程序开发,开发,实例,笔者,设计,24,自由,自由度,仿,型,机器,机器人,实时,仿真,控制,控制系统,系统,提高,系统,可移植,可移植性,移植,移植性,VxD,修改,PC,基板,CMOS,可编,可编程,编程,计数,计数器,获得,2KHz,系统,08,中断,频率,截获,中断,进行,实时,时调,调度,对此,基本,定时,信号,调度,获得,对外,对外部,外部,多通道,通道,模拟,模拟量,进行,采集,控制,控制算法,算法,处理,控制,输出,实时,屏幕,刷新,多任务,任务,定,信号,这种,方法,需要,要用,用户,提供,附加,硬件,定时,定时器,开发,中选,选定,Windows,98,软件,软件开发,开发,平台,充分,充分利用,分利,利用,32,CPU,操作,操作系统,系统,处理,能力,选择,Microsoft,Visual,C++,应用,应用层,ring,开发,开发工具,工具,应用,应用程序,程序,MFC,VxD,VtoolsD,04,编写,Ring,级,调试,试工,工具,NuMega,公司,SoftIce,23,本文,Ring,Ring,两层,软件,设计,说明,Ring,级,硬件,中断,VxD,设计,使用,QuickVxD,生成,框架,代码,过程,Device,Parameters,选单,应选,选中,Dynamically,Loadable,以使,驱动,驱动程序,程序,能够,动态,加载,Windows,95,control,messages,选单,中选,选中,W32,DEVICEIOCONTROL,消息,SYS,DYNAMIC,DEVICE,INIT,消息,SYS,DYNAMIC,DEVICE,EXIT,消息,消息,处理,处理函数,函数,以下,VxD,实现,现代,代码,说明,
#include,vtoolscp,h,
#include,winioctl,h,
#define,DEVICE,CLASS,IrqtestDevice
#define,IRQTEST,DeviceID,UNDEFINED,DEVICE,ID
#define,IRQTEST,Init,Order,UNDEFINED,INIT,ORDER
#define,IRQTEST,Major,1
#define,IRQTEST,Minor,0
#define,w32IF,PASS,EVENT,CTL,CODE
,FILE,DEVICE,UNKNOWN,METHOD,NEITHER,FILE,ANY,ACCESS,
#define,RTC,IRQ8,实时,时时,时钟,使用,IRQ
#define,STATREG,A,0xA
#define,STATREG,B,0xB
#define,STATREG,C,0xC
#defing,ENABLE,INTERRUPT,0x40
#define,WM,MY,MESSAGE,0x0410,自定,自定义,定义,消息,
BOOL,stdcall,RTCInt,Handler,VMHANDLE,hVM,IRQHANDLE,hIRQ,时钟,中断,服务,服务程序,程序,
VOID,WriteCMOS,BYTE,reg,BYTE,value,
BYTE,ReadCMOS,BYTE,reg,
class,IrqtestDevice,public,VDevice,
prblic,
virtual,BOOL,OnSysDynamicDeviceInit,
virtual,BOOL,OnSysDynamicDeviceExit,
virtual,DWORD,OnW32DeviceIoControl,PIOCTLPARAMS,pDIOCParams,
class,IrqtestVM,public,VVirtualMachine,
public,
IrqtestVM,VMHANDLE,hVM,
class,IrqtestThread,public,VThread,
public,
IrqtestThread,THREADHANDLE,hThread,IRQTEST,cpp,main,module,for,VxD,IRQTEST
#define,DEVICE,MAIN
#include,irqtest,h,
#undefDEVICE,MAIn
Declare,Virtual,Device,IRQTEST,
VPICD,HWInt,THUNK,RTCInt,Thunk,handler,中断,Thunk
EVENTHANDLE,hEvent,Handle,of,timer,event
IRQHANDLE,RTCIRQHandle,Handle,for,virtual,IRQ
BYTE,SavedStatusRegisterA,
BYTE,SavedStatusRegisterB,保存,RTC,设置,寄存,寄存器,
DWORD,TickCounter,中断,计数,计数器,
DWORD,PostMsghWnd,Ring3,层,应用,应用程序,程序,hWnd
HANDLE,hWnd,
IrqtestVM,IrqtestVM,VMHANDLE,hVM,
VVirtualMachine,hVM,
IrqtestThread,IrqtestThread,THREADHANDLE,hThread,
VThread,hThread,
BOOL,IrqtestDevice,OnSyaDynamicDeviceInit,
VMHANDLE,hVM,
hVM,Get,Cur,VM,Handle,
BYTE,statreg,
DWORD,status,
DWORD,RTClockFreqIndex,挂接,硬件,中断,需要,调用,虚拟,可编,可编程,编程,中断,控制,控制器,VPICD,通知,Windows,VxD,负责,处理,IRQ,只用,用到,VPICD,提供,五个,不同,IRQ,相关,通知,知事,事件,实际,硬件,中断,断事,事件,
struct,VPICD,IRQ,Descriptor,IRQdesc,结构,传入,VPICD,Virtualize,IRQ,例程,进行,初始,初始化,以下,参数,参数设置,设置,IRQdese,VID,IRQ,Number,RTC,IRQ,将要,虚拟,IRQ,IRQdesc,VID,Options,保留,结构,设置,中断,服务,服务例程,例程,地址,服务,服务例程,例程,thunk,地址,传递,递给,VPICD,Thunk,HWInt,负,带,thunk,初始,初始化,返回,地址,
IRQdesc,VID,Hw,Int,Proc,DWORD,VPICD,Thunk,HWInt
,RTCInt,Handler,RTCInt,Thunk,
IRQdesc,VID,IRET,Time,Out,500,结构,变量,没有,有用,用到,VPICD,Virtualize,IRQ,服务,已定,定义,结构,传入,VPICD,VPICD,分配,IRQ,返回,句柄,
RTCIRQHandle,VPICD,Virtualize,IRQ,IRQdesc,
if,RTCIRQHandle,returnFALSE,虚拟,虚拟化,失败,保存,初始,RTC,状态,寄存,寄存器,退出,恢复,复现,现场,
SavedStatusRegisterA,ReadCMOS,STATREG,A,
SavedStatusRegisterB,ReadCMOS,STATREG,B,
RTClockFreqIndex,设置,中断,频率,见下文,下文,文说,说明,
statreg,SavedStatusRegisterA,0xF,RTClockFreqIndex,0xF,
WriteCMOS,STATREG,A,statreg,设置,RTC,状态,寄存,寄存器,status,register,flags,to,enable,it,to,assert,its,IRQ
statreg,ReadCMOS,STATREG,B,
statreg,ENABLE,INTERRUPT,
WriteCMOS,STATREG,B,statreg,
ReadCMOS,STATREG,C,
TickCounter,初始,初始化,中断,计数,计数器,保证,IRQ,PIC,未,屏蔽,
VPICD,Physically,Unmask,RTCIRQHandle,
return,TRUE,
BOOL,IrqtestDevice,OnSysDynamicDeviceFxit,恢复,复现,现场,
Cancel,Global,Event,hEvent,
WriteCMOS,STATREG,A,SavedStatusRegister,A,
WriteCMOS,STATREG,B,SavedStatusRegister,B,
VPICD,Physically,Mask,RTCIRQHandle,
VPICD,Force,Default,Behavior,RTCIRQHandle,
return,TRUE,
DWORD,IrqtestDevice,OnW32DeviceIoControl
,PIOCTLPARAMS,pDIOCParams,
switch,pDIOCParams,dioc,IOCtICode,
case,DIOC,OPEN,CreateFile
,hWnd,Ring,层,应用,应用程序,程序,主,窗口,句柄,初始,初始化,
return,
case,W32IF,PASS,EVENT,
PostMsghWnd,DWORD,pDIOCParams,dioc,InBuf,
hWnd,HANDLE,PostMsghWnd,获得,得主,窗口,句柄,
return,
default,return,
return,
BOOL,stdcall,RTCInt,Handler,VMHANDLE,hVM,IRQHANDLE,hIRQ,中断,服务,服务例程,例程,中断,计数,计数器,计数,Ring,层,应用,应用程序,程序,发送,自定,自定义,定义,消息,
if,hWnd,TickCounter,100,
SHELL,PostMessage,hWnd,WM,My,MESSAGE,NULL,NULL,
TickCounter++,
ReadCMOS,STATREG,C,清除,RTC,状态,标志,
VPICD,Phys,EOI,hIRQ,指定,VPICD,清除,中断,
return,TRUE,thunk,清除,进位,篇幅,所限,COMS,端口,操作,两个,函数,ReadCMOS,BYTE,reg,WriteCMOS,BYTE,reg,BYTE,value,源程序,程序,略,请,参考,VtoolsD,机,帮助,CHIME,例子,Ring,级,主,应用,应用程序,程序,程序设计,设计,生成,VxD,放入,入主,应用,应用程序,程序,工作,目录,CreateFile,函数,动态,加载,VxD,hDevice,CreateFile,irqtest,vsd,OPEN,ALWAYS,FILE,FLAG,DELETE,ON,CLOSE,需要,挂接,中断,调用,DeviceIoControl,主程序,程序,窗口,句柄,传递,递给,运行,VxD,
Main,CWnd,AfxGetMainWnd,
inBuf,Main,CWnd,m,hWnd,
if,DeviceIoControl,hDevice,W32IF,PASS,EVENT,inBut,sizeof,PVOID,RetInfo,sizeof
,RetInfo,cbBytesRetumed,NULL,
AfxMessageBox,DeviceIoCtl,Failed,MB,OK,VxD,通讯,失败,自定,自定义,定义,消息,处理,处理函数,函数,中加,加入,实时,实时处理,处理,代码,需要,要说,说明,以下,以下几点,几点,VxD,中断,处理,处理函数,函数,加入,实时,实时性,要求,最高,代码,原则,原则上,应尽,尽快,返回,提高,高中,中断,频率,避免,重入,中断,频率,选择,参数,n,以下,选择,

n,频率,Hz,n,频率,Hz,
12567512
21281064
381921132
440961216
52048138
61024144

,本文,介绍,方法,同样,适用,用于,编写,普通,硬件,中断,VxD,中断,频率,高,数据,采集,系统,设置,双,缓冲,缓冲区,实现,现实,实时,中断,处理,线程,同步,五,结论,本文,PC,Windows,9X,9X,进行,细致,研究,之后,分析,构造,实时,系统,方法,详细,应用,示例,给出,说明,本文,使用,方法,具有,通用,通用性,和易,易用,易用性,笔者,设计,24,自由,自由度,仿,型,机器,机器人,控制,控制系统,系统,运行,良好,本文,介绍,方法,开发,Windows,9X,实时,实时控制,控制,控制系统,系统,具有,实际,参考,参考价,参考价值,价值,作者,单位,姜,山,上海,上海交通大学,交通,大学,存储,研究,中心,200030,参考,参考文献,文献,Dean,J,Petrone,Michael,D,Stackhouse,PC,Based,Control,Goes,Real,ti,me,Control,Engineering,Apil,1998
,Martin,Timmermon,Windows,NT,Real,time,extensions,better,or,worse,R,eal,time,Magazine,Mar,1998
,张,维,铭,使用,VtoolsD,开发,Windwos,95,虚拟,拟设,设备,驱动,驱动程序,程序,中国,国计,计算,计算机,计算机用户,算机,机用户,用户,1997,12
,Paolo,Fiorini,Homayoum,Seraji,Mark,Long,A,PC,Based,Configuration,Controller,for,Dexterous,DOF,Arms,M,IEEE,Robotics,and,Automation,Magazine,Vol,ume,September,1997,pp,30,38
,收稿,日期,1999,07,05
