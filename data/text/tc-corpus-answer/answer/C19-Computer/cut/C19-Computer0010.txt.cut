计算,计算机,算机,应用,
COMPUTER,APPLICATIONS
1999,19,卷,Vol,19,No,1999



Windows,95,串行,通信,编程,编程技术,技术,其实,实现,郭,峰林,朱,摘,本文,文首,简单,讨论,MSDOS,16,Windows,Windows95,通信,编程,差别,着重,讲述,32,Windows95,环境,通信,编程,编程技术,技术,最后,给出,利用,技术,实现,串行,通信,实例,关键,关键词,API,函数,串行,通信,中断,查询,线程,同步,异步,阻塞,
TECHNIQUE,OF,SERIAL,COMMUNICATION,PROGRAMMING
AND,ITS,REALIZATION,IN,WINDOWS95
Guo,Fenglin,Zhu,Cailian
Institute,of,Geodesy,Geophysics,Chinese,Academy,of,Sciences,Hubei,Wuhan,430077
,Abstract,This,paper,discusses,the,difference,of,communication,programming,in,the,operating,system,of,MSDOS,16,bit,Windows,and,Windows95,Then,tells,of,some,problems,about,serial,communication,programming,technique,in,32,bit,OS,of,windows95,Finally,an,example,of,the,application,of,this,technique,in,windows95is,provided,Keywords,API,function,Serial,communication,Interrupt,Poll,Thread,Synchronization,Asynchronization
1,前言,Windows95,以其,形象,图形,图形界面,界面,界面设计,设计,操作,简单,功能,功能强大,强大,可靠,可靠性,高等,优点,赢得,越来,越来越,越多,用户,开发,Windows95,应用,应用程序,程序,已经,成为,当今,主流,诸多,应用,开发,外部,硬件,设备,通信,常见,应用,串行,通信,以其,简单,硬件,连接,方式,常常,常成,成为,应用,开发,开发者,首选,串行,通信,编程,MSDOS,Windows3,Windows95,各不相同,相同,功能,越来,越来越,强,编程,复杂,复杂度,相应,应增,增大,笔者,最近,近在,Windows95,环境,开发,一套,公安,110,智能,报警,系统,该系,系统,需要,报警,电话,进行,实时,监控,实时,进行,接警,处警,报警,电话,监控,检测,电话,交换,交换机,换机,馈送,RS232,标准,串行,通信,信号,串行,串行口,通信,采用,线,方式,该系,系统,采用,Windows95,Visual,C++,编写,Windows95,串行,串行口,通信,编程,资料,串行,通信,编程,实例,不多,不多见,笔者,成功,开发,公安,110,智能,报警,系统,基础,取得,经验,现在,串行,串行口,通信,关键,关键技术,技术,写出,供,广大,编程,借鉴,参考,串行,通信,编程,特征,MSDOS,串行,通信,编程,简单,通信,编程,直接,串口,物理,物理地址,地址,进行,编程,操作,配合,BIOS,调用,即可,实现,串行,串行口,数据,读写,Windows,串行,串行口,系统,系统资源,资源,设备,驱动,驱动程序,程序,统一,一管,管理,用户,不能,象,MSDOS,直接,串行,串行口,硬件,端口,进行,编程,16,Windows3,操作,操作系统,系统,提供,专门,串行,通信,API,函数,OpenComm,CloseComm,ReadComm,WriteComm,专用,API,Application,Programming,Interfaces,函数,设置,读,写,串行,串行口,Windows95,串行,串行口,通信,设备,Modern,传真,传真机,统一,视作,作文,文件,串行,串行口,打开,关闭,读写,操作,操作,普通,文件,API,函数,相同,CreateFile,CloseHandel,ReadFile,WriteFile,函数,多态,多态性,需要,结合,Windows95,线程,编程,事件,事件驱动,驱动,新,技术,而使,Windows95,串行,串行口,通信,编程,比较,比较复杂,复杂,Windows95,串行,通信,API,函数,Windows95,中将,串行,串行口,文件,统一,起来,打开,读,写,关闭,操作,使用,相同,API,函数,之间,差别,串行,串行口,不能,象,文件,被删,删除,差别,别体,体现,现在,API,函数,中部,部分,参数,设置,弄清,串行,通信,API,函数,用法,掌握,串行,通信,编程,编程技术,技术,关键,下面,介绍,几个,串行,通信,编程,密切,密切相关,相关,API,函数,着重,说明,API,函数,进行,串行,通信,参数,参数设置,设置,需要,注意,地方,没有,提及,函数,参数,参考,Windows95,API,函数,手册,打开,串行,串行口,API,函数,Windows95,通信,调用,CreateFile,函数,打开,串行,串行口,调用,CreateFile,打开,串口,成功,返回,一个,操作,句柄,句柄,供,串行,串行口,设置,读写,操作,作用,CreateFile,函数,原型,HANDLE,CreateFile,LPCTSTR,szDevice,DWORD,dwAccess,
DWORD,dwShareMode,LPSECURITY,ATTRIBUTES,lpSA,
DWORD,dwCreate,DWORD,dwFlagsAndAttributes,
HANDLE,hTemplateFile,调用,函数,注意,几个,参数,设置,dwShareMode,指定,端口,共享,属性,参数,文件,文件共享,共享,提供,串行,串行口,不能,共享,设备,参数,参数值,数值,必须,文件,通信,设备,之间,主要,差异,dwCreate,必须,OPEN,EXISTING,CreateFile,只能,打开,存在,端口,不能,象,创建,建新,新文,文件,创建,建物,物理,理上,不存,存在,新,串口,dwFlagsAndAttributes,描述,端口,种属,属性,文件,具有,多种,种属,属性,只读,隐藏,系统,可能,串行,串行口,唯一,有意,意义,设置,FILE,FLAG,OVERLAPPED,参数,hTemplateFile,必须,NULL,返回,返回值,成功,返回,创建,句柄,返回,INVALID,HANDLE,VALUE,举例,打开,串行,串行口,HANDLE,hComm,定义,句柄,变量,hComm,CreateFile,COM1,GENERIC,READ,GENERIC,WRITE,NULL,NULL,OPEN,EXISTING,FILE,FLAG,OVERLAPPED,NULL,if,hComm,INVALID,HANDLE,VALUE,打开,串口,错误,处理,配置,串行,串行口,API,函数,串行,串行口,打开,开成,成功,接下,接下来,下来,配置,串行,串行口,通信,参数,波特,波特率,数据,数据位,位数,停止,校验,校验位,修改,参数,设备,控制,块,DCB,Device,Control,Block,打交道,交道,DCB,近,30,个数,数据,成员,一个,复杂,数据,数据结构,结构,弄清,弄清楚,清楚,含义,相当,费时,采用,线,方式,串行,通信,DCB,结构,绝大,绝大多数,大多,大多数,多数,参数,不予,不予考虑,考虑,设置,波特,波特率,数据,数据位,停止,校验,校验位,几个,关键,参数,行,介绍,一种,简捷,方法,做到,不了,了解,DCB,详细,内容,设置,串行,通信,参数,下面,程序,说明,串行,通信,参数,设置,方法,例程,利用,BuildCommDCB,函数,设置,DCB,后用,函数,SetCommState,配置,串行,通信,信口,
DCB,dcb,定义,设备,控制,块,
GetCommState,hComm,dcb,取出,系统,缺省,设备,控制,块,
BuildCommDCB,COM2,9600,N,dcb,设置,DCB,主要,主要参数,参数,
SetCommState,hComm,dcb,超时,设置,API,函数,编写,通信,应用,应用程序,程序,一个,关键,问题,处理,通信,不可,预测,事件,接收,接收数据,数据,过程,突然,中断,发送,发送数据,数据,突然,停止,认真,认真对待,真对,情况,可能,引起,I,O,线程,挂起,线程,无限,阻塞,Windows95,这类,问题,提供,安全,安全措施,措施,超时,设置,决定,通信,是否,异常,并作,相应,处理,超时,设置,串行,通信,显得,尤为,尤为重要,为重,重要,超时,设置,过程,分为,两步,设置,COMMTIMEOUTS,结构,五个,变量,调用,SetCommTimeouts,函数,设置,超时,时值,COMMTIMEOUTS,结构,定义,typedef,struct,COMMTIMEOUTS,
DWORD,ReadIntervalTimeout,读,端口,口间,间隔,超时,
DWORD,ReadTotalTimeoutMultiplier,读,端口,超时,乘数,
DWORD,ReadTotalTimeoutConstant,读,端口,超时,时常,常数,ms,
DWORD,WriteTotalTimeoutMultiplier,写,端口,超时,乘数,
DWORD,WriteTotalTimeoutConstant,写,端口,超时,时常,常数,ms,COMMTIMEOUTS,LPCOMMTIMEOUTS,读,串口,API,函数,串行,串行口,打开,进行,读写,读写操作,操作,读,串行,串行口,函数,原型,BOOL,ReadFile,HANDLE,hFile,LPVOID,lpBuffer,
DWORD,nNumberOfBytesToRead,
LPDWORD,lpNumberOfBytesRead,
LPOVERLAPPED,lpOverlapped,data,第一,第一个,一个,参数,hFile,CreateFile,返回,句柄,参数,lpBuffer,读取,数据,缓冲,缓冲区,指针,注意,数据,缓冲,缓冲区,区分,分配,足够,空间,参数,nNumberOfBytesToRead,读取,字节,字节数,节数,参数,lpNumberOfBytesRead,实际,读取,字节,字节数,节数,最后,一个,参数,lpOverlapped,指向,一个,重叠,I,O,异步,数据,数据结构,结构,指针,lpOverlapped,设置,NULL,ReadFile,工作,同步,方式,lpOverlapped,指向,一个,重叠,结构,工作,异步,方式,写,串口,API,函数,BOOL,WriteFile,HANDLE,hFile,CreateFile,返回,句柄,LPCVOID,lpBuffer,写,缓冲,缓冲区,指针,DWORD,nNumberOfBytesToWrite,写,字节,字节数,节数,LPDWORD,lpNumberOfBytesWritten,实际,写,字节,字节数,节数,LPOVERLAPPED,lpOverlapped,指向,一个,重叠,I,O,数据,数据结构,结构,WriteFile,函数,工作,方式,选择,ReadFile,相同,不重,重复,关闭,串口,API,函数,串行,串行口,是非,共享,共享资源,资源,应用,应用程序,程序,打开,串行,串行口,独占,资源,应用,应用程序,程序,无法,访问,应用,应用程序,程序,释放,串口,打开,串口,一定,定要,关闭,串口,关闭,串口,函数,简单,函数,原型,BOOL,CloseHandle,HANDLE,hObject,hObject,参数,CreateFile,返回,端口,句柄,返回,返回值,调用,成功,Windows95,串行,通信,工作,方式,串行,通信,调用,CreateFile,函数,打开,串行,串行口,设置,串行,串行口,波特,波特率,数据,数据位,校验,校验位,停止,参数,超时,参数,最后,选择,一种,工作,方式,读,写,串行,串行口,Windows95,串行,通信,两种,工作,方式,可供,供选择,选择,查询,方式,事件,事件驱动,驱动,方式,两种,工作,方式,优缺点,缺点,用户,应用,应用程序,程序,实际,需要,选择,一种,工作,方式,下面,面对,两种,工作,方式,别介,介绍,查询,方式,串口,读取,读取数据,数据,查询,最为,直接,易于,理解,技术,查询,占用,大量,CPU,时间,效率,低,利用,查询,方式,读取,串口,数据,通常,建立,一个,线程,建立,线程,使用,CreateThread,函数,循环,查询,在线,线程,进行,举例,假设,端口,已经,经打,打开,DWORD,ReadThread,LPDWORD,lpdwParam,BYTE,Buff,100,读数,读数据,数据,缓冲,缓冲区,
DWORD,nBytesRead,实际,读取,字节,字节数,节数,
COMMTIMEOUTS,Timeouts,超时,设置,
Memset,Timeouts,sizeof,COMMTIMEOUTS,
Timeouts,ReadIntervalTimeout,MAXDWORD,
SetCommTimeouts,hComm,Timeouts,
While,bReading,
if,ReadFile,hComm,Buff,100,nBytesRead,NULL,读取,读取数据,数据,出错,错处,处理,
else,正确,读取,读取数据,数据,处理,
PurgeComm,hComm,PURGE,RXCLEAR,
return,例程,线程,退出,bReading,标志,控制,bReading,TRUE,循环,串口,breading,FALSE,线程,退出,事件,事件驱动,驱动,方式,事件,事件驱动,驱动,I,O,方式,指,线程,监视,通信,资源,一组,事件,进行,I,O,操作,这种,方式,类似,MSDOS,中断,工作,方式,效率,效率高,监视,事件,列表,

,事件,掩码,含义,
EV,BREAK,检测,测到,输入,终止,
EV,CTSCTS,清除,发送,信号,改变,状态,
EV,DSRDSR,数据,设置,就绪,信号,改变,状态,
EV,ERR,发生,线路,状态,错误,
EV,RING,检测,测到,振铃,
EV,RLSDRLSD,信号,改变,状态,
EV,RXCHAR,收到,到任,字符,放进,输入,缓冲,缓冲区,
EV,RXFLAG,收到,事件,字符,放进,输入,缓冲,缓冲区,
EV,TXEMPTY,输出,缓冲,缓冲区,最后,一个,个字符,字符,发送,送出,送出去,出去,

,实际,编程,串行,串行口,读,写,操作,需要,建立,两个,工作,工作者,作者,线程,在读,写,线程,SetCommMask,函数,设置,事件,屏蔽,监视,指定,通信,资源,事件,指定,一组,事件,线程,以使,使用,WaitCommEvent,函数,数等,等待,一个,事件,发生,等待,过程,花费,极少,CPU,时间,注意,WaitCommEvent,函数,读写,读写操作,操作,函数,同步,使用,异步,使用,主要,取决,取决于,第三,第三个,三个,参数,是否,指定,OVERLAPPED,结构,指定,定为,NULL,该函,函数,同步,必须,SetCommMask,中指,指定,事件,一个,发生,返回,指定,一个,OVERLAPPED,结构,该函,函数,工作,异步,方式,通常,该函,函数,工作,同步,方式,下面,例程,演示,利用,事件,事件驱动,驱动,I,O,方式,串行,串行口,读取,读取数据,数据,
DWORD,ReadThread,LPDWORD,lpdwParam,BYTE,Buff,100,读数,读数据,数据,缓冲,缓冲区,
DWORD,nBytesRead,dwEvent,dwError,
COMMTIMEOUTS,Timeouts,超时,设置,
Memset,Timeouts,sizeof,COMMTIMEOUTS,
Timeouts,ReadTotalTimeoutMultiplier,
Timeouts,ReadTotalTimeoutConstant,100,
SetCommTimeouts,hComm,Timeouts,
SetCommMask,hComm,EV,RXCHAR,设置,EV,RXCHAR,掩码,字符,到达,产生,生事,事件,
While,bReading,
if,WaitCommEvent,hComm,dwEvent,NULL,接收,接收缓冲区,缓冲,缓冲区,字符,到达,
if,dwEvent,EV,RXCHAR,确认,EV,RXCHAR,事件,
if,ReadFile,hComm,Buff,nBytesRead,NULL,处理,读错,错误,
else,正确,接收,收字,字符,处理,else,EV,RXCHAR,事件,处理,
PurgeComm,hComm,PURGE,RXCLEAR,
return,上面,例程,设置,EV,RXCHAR,事件,掩码,告诉,Windows,接收,收到,一个,字节,产生,一个,事件,WaitCommEvent,返回,比较,该函,函数,返回,事件,掩码,EV,RXCHAR,说明,接收,接收缓冲区,缓冲,缓冲区,至少,少有,一个,个字符,字符,处于,等待,状态,错误,误事,事件,需要,进行,错误,错误处理,处理,效果,作者,开发,公安,110,智能,报警,系统,利用,事件,事件驱动,驱动,方式,串行,通信,编程,编程技术,技术,处理,多种,种系,系统,设备,频繁,数据,数据交换,交换,任务,应用,非常,常成,成功,系统,实时,监控,市话,市话网,网上,不断,传来,报警,电话,作者,作者简介,简介,郭,峰林,硕士,研究,研究生,朱,博士,博士生,导师,研究,研究员,作者,单位,中国,中国科学院,科学,科学院,学院,测量,地球,地球物理,物理,研究,研究所,湖北,武昌,430077,参考,参考文献,文献,Microsoft,Corporation,著,Win32,程序,程序员,参考,大全,欣,力,译,北京,清华,清华大学,清华大学出版社,华大,大学,出版,出版社,1995,Microsoft,Corporation,Microsoft,Developer,Network
,Peter,W,Gofton,著,精通,串行,通信,王,仲,文,译,北京,电子,工业,出版,出版社,1995,Charles,A,Mirho,Andre,Terrisse,著,Windows95,通信,编程,贺,军,译,北京,清华,清华大学,清华大学出版社,华大,大学,出版,出版社,1997,12
,Scott,Stanfield,RalphArvesen,著,Visual,C++4,开发,开发人员,发人,人员,指南,北京,机械,机械工业,工业,出版,出版社,1997,收稿,日期,1999,03,11,修改,修改稿,改稿